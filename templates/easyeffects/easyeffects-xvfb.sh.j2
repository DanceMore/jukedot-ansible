#!/bin/bash
# EasyEffects Headless Control Script
# Generated by Ansible

DISPLAY="{{ xvfb_display }}"
SCREEN="{{ xvfb_screen }}"
USER="{{ easyeffects_user }}"
export XDG_RUNTIME_DIR="/run/user/$(id -u ${USER})"

case "$1" in
    start)
        # Kill any existing Xvfb processes
        pkill Xvfb || true
        sleep 1
        
        # Start Xvfb
        Xvfb "${DISPLAY}" -screen 0 "${SCREEN}" &
        sleep 3
        
        # Export display for EasyEffects
        export DISPLAY="${DISPLAY}"
        
        # Start EasyEffects (systemd unit should run as $USER)
        easyeffects --gapplication-service

        # alsop run mpd here for xsession winning and not systemd
        mpd &
        ;;
    
    stop)
        # Stop EasyEffects
        export DISPLAY="${DISPLAY}"
        easyeffects --quit || true
        sleep 2
        
        # Kill Xvfb
        pkill Xvfb || true
        ;;
    
    status)
        echo "Checking EasyEffects and Xvfb status..."
        if pgrep -f "Xvfb ${DISPLAY}" >/dev/null; then
            echo "Xvfb is running"
        else
            echo "Xvfb is not running"
        fi
        
        if pgrep -f "easyeffects" >/dev/null; then
            echo "EasyEffects is running"
        else
            echo "EasyEffects is not running"
        fi
        ;;
    
    *)
        echo "Usage: $0 {start|stop|status}"
        exit 1
        ;;
esac
