---
- name: Install MPD audio receiver
  hosts: all
  become: yes
  vars:
    mpd_user: "mpd"
  
  vars:
    mpd_playlists:
      - name: fm-c895.m3u
        content: "http://knhc-ice.streamguys1.com:80/live"
      - name: fm-kexp.m3u
        content: "https://kexp.streamguys1.com/kexp160.aac"
      - name: fm-vanbc-coop.m3u
        content: "https://listen-coopradio.sharp-stream.com/coopradio.mp3?ver=247482"
      - name: jukebox.m3u
        content: "http://nas.dance.more:10000/jukebox.mp3"
      - name: somafm-beat-blender.m3u
        content: "https://ice5.somafm.com/beatblender-128-mp3"
      - name: somafm-groove-salad.m3u
        content: "https://ice5.somafm.com/groovesalad-128-mp3"
      - name: somafm-secret-agent.m3u
        content: "https://ice5.somafm.com/secretagent-128-mp3"
      - name: somafm-suburbs-of-goa.m3u
        content: "https://ice5.somafm.com/suburbsofgoa-128-mp3"
      - name: somafm-the-in-sound.m3u
        content: "https://ice5.somafm.com/insound-128-mp3"

  tasks:
    - name: Install packages
      apt:
        name:
          - mpd
          - mpc
          - ncmpcpp
          - pipewire
          - pipewire-pulse
          - wireplumber
        state: present
        update_cache: yes

    - name: Copy MPD config
      template:
        src: ../templates/mpd.conf.j2
        dest: "/home/{{ mpd_user}}/mpd.conf"

    - name: Ensure MPD playlists directory exists
      file:
        path: /var/lib/mpd/playlists
        state: directory
        owner: "{{ mpd_user }}"
        group: audio
        mode: '0755'

    - name: Create MPD playlist files
      copy:
        dest: "/var/lib/mpd/playlists/{{ item.name }}"
        content: "{{ item.content }}\n"
        owner: mpd
        group: audio
        mode: '0644'
      loop: "{{ mpd_playlists }}"

    - name: Copy ZEDi8 udev rule
      copy:
        dest: /etc/udev/rules.d/99-zedi8-mpd.rules
        content: |
          SUBSYSTEM=="sound", ATTR{idVendor}=="22f0", ATTR{idProduct}=="0014", ACTION=="add", SYMLINK+="zedi8", TAG+="systemd", ENV{SYSTEMD_WANTS}="mpd.service"
          SUBSYSTEM=="sound", ATTRS{idVendor}=="22f0", ATTRS{idProduct}=="0014", ACTION=="change", RUN+="/usr/local/sbin/zedi8-restart-mpd.sh"

    - name: Copy ZEDi8 restart script
      copy:
        dest: /usr/local/sbin/zedi8-restart-mpd.sh
        mode: '0755'
        content: |
          #!/bin/bash
          # Script to restart MPD when ZEDi8 is reconnected
          # Define the device path
          DEVICE_PATH="/dev/snd/pcmC1D0c"
          logger "[+] ZEDi8 reconnection triggered for device ${DEVICE_PATH}, sleeping..."
          sleep 10
          logger "[+] ZEDi8 reconnection 10sec sleep completed."

    # defer to userland call, not systemd
    - name: Enable MPD service
      systemd:
        name: mpd
        enabled: no
        state: stopped
      when: not ansible_check_mode

    - name: Ensure MPD logs owned by userland
      file:
        path: /var/log/mpd
        owner: "{{ mpd_user }}"
        group: audio
        recurse: yes

    - name: Ensure MPD run owned by userland
      file:
        path: /run/mpd
        owner: "{{ mpd_user }}"
        group: audio
        recurse: yes
